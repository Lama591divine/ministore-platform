services:
  e2e:
    image: golang:1.25
    working_dir: /src
    volumes:
      - ./:/src
    environment:
      - E2E_BASE_URL=http://gateway:8080
    depends_on:
      gateway:
        condition: service_started
    command:
      - bash
      - -lc
      - |
        # wait until gateway port is open (max ~60s)
        for i in {1..60}; do
          (echo > /dev/tcp/gateway/8080) >/dev/null 2>&1 && break
          sleep 1
        done
        go test -tags=integration ./...
    networks: [ backend ]

  postgres_auth:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: authdb
    healthcheck:
      test: [ "CMD-SHELL", "psql -U postgres -d authdb -c 'SELECT 1' >/dev/null 2>&1" ]
      interval: 5s
      timeout: 5s
      retries: 40
      start_period: 20s
    networks: [ backend ]

  postgres_catalog:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: catalogdb
    healthcheck:
      test: [ "CMD-SHELL", "psql -U postgres -d catalogdb -c 'SELECT 1' >/dev/null 2>&1" ]
      interval: 5s
      timeout: 5s
      retries: 40
      start_period: 20s
    networks: [ backend ]

  postgres_order:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: orderdb
    healthcheck:
      test: [ "CMD-SHELL", "psql -U postgres -d orderdb -c 'SELECT 1' >/dev/null 2>&1" ]
      interval: 5s
      timeout: 5s
      retries: 40
      start_period: 20s
    networks: [ backend ]

  migrate_auth:
    image: migrate/migrate:v4.17.1
    depends_on:
      postgres_auth:
        condition: service_healthy
    volumes:
      - ./migrations/auth:/migrations
    command:
      - "-path"
      - "/migrations"
      - "-database"
      - "postgres://postgres:postgres@postgres_auth:5432/authdb?sslmode=disable"
      - "up"
    networks: [ backend ]

  migrate_catalog:
    image: migrate/migrate:v4.17.1
    depends_on:
      postgres_catalog:
        condition: service_healthy
    volumes:
      - ./migrations/catalog:/migrations
    command:
      - "-path"
      - "/migrations"
      - "-database"
      - "postgres://postgres:postgres@postgres_catalog:5432/catalogdb?sslmode=disable"
      - "up"
    networks: [ backend ]

  migrate_order:
    image: migrate/migrate:v4.17.1
    depends_on:
      postgres_order:
        condition: service_healthy
    volumes:
      - ./migrations/order:/migrations
    command:
      - "-path"
      - "/migrations"
      - "-database"
      - "postgres://postgres:postgres@postgres_order:5432/orderdb?sslmode=disable"
      - "up"
    networks: [ backend ]

  auth:
    build:
      context: .
      args:
        SERVICE: auth
        GO_VERSION: "1.25"
    environment:
      - PORT=8081
      - JWT_SECRET=${JWT_SECRET}
      - METRICS_TOKEN=${METRICS_TOKEN}
      - POSTGRES_DSN=postgres://postgres:postgres@postgres_auth:5432/authdb?sslmode=disable
    depends_on:
      migrate_auth:
        condition: service_completed_successfully
    networks: [ backend ]

  catalog:
    build:
      context: .
      args:
        SERVICE: catalog
        GO_VERSION: "1.25"
    environment:
      - PORT=8082
      - METRICS_TOKEN=${METRICS_TOKEN}
      - POSTGRES_DSN=postgres://postgres:postgres@postgres_catalog:5432/catalogdb?sslmode=disable
    depends_on:
      migrate_catalog:
        condition: service_completed_successfully
    networks: [ backend ]

  order:
    build:
      context: .
      args:
        SERVICE: order
        GO_VERSION: "1.25"
    environment:
      - PORT=8083
      - JWT_SECRET=${JWT_SECRET}
      - METRICS_TOKEN=${METRICS_TOKEN}
      - CATALOG_URL=http://catalog:8082
      - POSTGRES_DSN=postgres://postgres:postgres@postgres_order:5432/orderdb?sslmode=disable
    depends_on:
      migrate_order:
        condition: service_completed_successfully
      catalog:
        condition: service_started
    networks: [ backend ]

  gateway:
    build:
      context: .
      args:
        SERVICE: gateway
        GO_VERSION: "1.25"
    environment:
      - PORT=8080
      - JWT_SECRET=${JWT_SECRET}
      - METRICS_TOKEN=${METRICS_TOKEN}
      - AUTH_URL=http://auth:8081
      - CATALOG_URL=http://catalog:8082
      - ORDER_URL=http://order:8083
    ports:
      - "8080:8080"
    depends_on:
      auth:
        condition: service_started
      catalog:
        condition: service_started
      order:
        condition: service_started
    networks: [ frontend, backend ]

  prometheus:
    image: prom/prometheus:v2.51.1
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    environment:
      - METRICS_TOKEN=${METRICS_TOKEN}
    depends_on:
      gateway:
        condition: service_started
    networks: [ backend ]

  grafana:
    image: grafana/grafana:10.4.0
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      prometheus:
        condition: service_started
    networks: [ backend ]

networks:
  frontend: {}
  backend:
    internal: true